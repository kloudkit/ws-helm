{{- define "workspace.hardcodedValues" -}}
{{- $ws := .Values.workspace | default dict -}}
global:
  {{- $labels := dict }}
  {{- with (dig "owner" nil $ws) }}
  {{- $_ := set $labels "ws.kloudkit.com/owner" (toString .) }}
  {{- end }}
  {{- with (dig "project" nil $ws) }}
  {{- $_ := set $labels "ws.kloudkit.com/project" (toString .) }}
  {{- end }}
  {{- with (dig "labels" nil $ws) }}
  {{- $_ := mergeOverwrite $labels . }}
  {{- end }}
  labels: {{ toYaml $labels | nindent 4 }}
  annotations: {{ toYaml (dig "annotations" (dict) $ws) | nindent 4 }}

controllers:
  main:
    revisionHistoryLimit: 3

    pod:
      {{- with (dig "hostname" nil $ws) }}
      hostname: {{ tpl (toString .) $ | quote }}
      {{- end }}

      {{- with (dig "nodeSelector" nil $ws) }}
      nodeSelector: {{ toYaml . | nindent 8 }}
      {{- end }}

      {{- with (dig "tolerations" nil $ws) }}
      tolerations: {{ toYaml . | nindent 8 }}
      {{- end }}

      {{- with (dig "affinity" nil $ws) }}
      affinity: {{ toYaml . | nindent 8 }}
      {{- end }}

    containers:
      main:
        image:
          repository: {{ dig "image" "repository" "ghcr.io/kloudkit/workspace" $ws }}
          tag: {{ dig "image" "tag" .Chart.AppVersion $ws | quote }}
          pullPolicy: {{ dig "image" "pullPolicy" "IfNotPresent" $ws }}

        env:
          {{- with (dig "timezone" nil $ws) }}
          TZ: {{ . | quote }}
          {{- end }}

          {{- include "workspace.wsEnv" . | nindent 10 }}

          {{- with (dig "env" nil $ws) }}
          {{- toYaml . | nindent 10 }}
          {{- end }}

        {{- with (dig "envFrom" nil $ws) }}
        envFrom:
          {{- toYaml . | nindent 10 }}
        {{- end }}

        {{- with (dig "securityContext" nil $ws) }}
        securityContext: {{ toYaml . | nindent 10 }}
        {{- end }}

        probes:
          liveness:
            enabled: true
            type: HTTP
            path: /healthz
            port: {{ include "workspace.serverPort" . }}

          readiness:
            enabled: true
            type: HTTP
            path: /healthz
            port: {{ include "workspace.serverPort" . }}

service:
  main:
    controller: main
    ports:
      http:
        port: {{ include "workspace.serverPort" . }}
      {{- if (dig "config" "metrics" "enable" false $ws) }}
      metrics:
        port: {{ include "workspace.metricsPort" . }}
      {{- end }}

{{- if (dig "config" "metrics" "enable" false $ws) }}
serviceMonitor:
  main:
    enabled: true
    endpoints:
      - port: metrics
        scheme: http
        path: /
        interval: 1m
        scrapeTimeout: 10s
{{- end }}

{{- if (dig "ingress" "enabled" false $ws) }}
ingress:
  main:
    {{- with (dig "ingress" "className" nil $ws) }}
    className: {{ . }}
    {{- end }}
    hosts:
      {{- $proxyDomains := dig "config" "server" "proxy_domain" nil $ws }}
      {{- if $proxyDomains }}
        {{- if kindIs "string" $proxyDomains }}
          {{- $proxyDomains = list $proxyDomains }}
        {{- end }}
        {{- range $proxyDomains }}
          {{- $raw := toString . }}
          {{- $raw = replace (printf "%s%s%s%s%s" "{{" "`" "{{port}}" "`" "}}") "__PORT__" $raw }}
          {{- $raw = replace (printf "%s%s" "{{" "port}}") "__PORT__" $raw }}
          {{- $host := regexReplaceAll "__PORT__-?" (tpl $raw $) "" }}
      - host: {{ $host | quote }}
        paths: &defaultPaths
          - path: /
            service:
              identifier: main
              port: http
      - host: {{ printf "*.%s" $host | quote }}
        paths: *defaultPaths
        {{- end }}
      {{- end }}
    {{- with (dig "ingress" "tls" nil $ws) }}
    tls: {{ toYaml . | nindent 6 }}
    {{- end }}
    {{- with (dig "ingress" "annotations" nil $ws) }}
    annotations: {{ toYaml . | nindent 6 }}
    {{- end }}
{{- end }}

{{- if (dig "persistence" "enabled" true $ws) }}
persistence:
  workspace:
    type: {{ dig "persistence" "type" "persistentVolumeClaim" $ws }}
    accessMode: {{ dig "persistence" "accessMode" "ReadWriteOnce" $ws }}
    size: {{ dig "persistence" "size" "25Gi" $ws }}
    {{- with (dig "persistence" "storageClass" nil $ws) }}
    storageClassName: {{ . }}
    {{- end }}
    globalMounts:
      - path: {{ include "workspace.serverRoot" . }}
        subPath: workspace
      - path: /home/kloud/.cache/history
        subPath: history
{{- end }}
{{- end }}

{{- $ctx := deepCopy . -}}
{{- $_ := include "workspace.hardcodedValues" . | fromYaml | mergeOverwrite $ctx.Values -}}
{{- include "bjw-s.common.loader.all" $ctx }}
