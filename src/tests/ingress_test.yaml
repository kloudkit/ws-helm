---
suite: Ingress configuration
templates:
  - templates/workspace.yaml
tests:
  - it: should set ingress className
    set:
      workspace:
        ingress:
          enabled: true
          className: nginx
    documentSelector:
      path: kind
      value: Ingress
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: should configure TLS
    set:
      workspace:
        ingress:
          enabled: true
          host: workspace.example.com
          tls:
            - secretName: ws-tls
              hosts:
                - workspace.example.com
    documentSelector:
      path: kind
      value: Ingress
    asserts:
      - isSubset:
          path: spec.tls[0]
          content:
            secretName: ws-tls
            hosts:
              - workspace.example.com

  - it: should create exact and wildcard ingress hosts from primary domain
    set:
      workspace:
        ingress:
          enabled: true
        domains:
          primary: ws.example.com
    documentSelector:
      path: kind
      value: Ingress
    asserts:
      - equal:
          path: spec.rules[0].host
          value: ws.example.com
      - equal:
          path: spec.rules[1].host
          value: "*.ws.example.com"

  - it: should create exact and wildcard hosts for primary and proxy domains
    set:
      workspace:
        ingress:
          enabled: true
        domains:
          primary: primary.example.com
          proxies:
            - secondary.example.com
    documentSelector:
      path: kind
      value: Ingress
    asserts:
      - equal:
          path: spec.rules[0].host
          value: primary.example.com
      - equal:
          path: spec.rules[1].host
          value: "*.primary.example.com"
      - equal:
          path: spec.rules[2].host
          value: secondary.example.com
      - equal:
          path: spec.rules[3].host
          value: "*.secondary.example.com"

  - it: should extract base domain and wildcard from port-templated proxy domain
    set:
      workspace:
        ingress:
          enabled: true
        domains:
          primary: "{{`{{port}}`}}-{{ .Release.Name }}.some-domain"
    documentSelector:
      path: kind
      value: Ingress
    asserts:
      - equal:
          path: spec.rules[0].host
          value: RELEASE-NAME.some-domain
      - equal:
          path: spec.rules[1].host
          value: "*.RELEASE-NAME.some-domain"

  - it: should set ingress annotations
    set:
      workspace:
        ingress:
          enabled: true
          annotations:
            nginx.ingress.kubernetes.io/proxy-body-size: 100m
    documentSelector:
      path: kind
      value: Ingress
    asserts:
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/proxy-body-size"]
          value: 100m
