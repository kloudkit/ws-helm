---
suite: Master key env injection
templates:
  - templates/workspace.yaml
tests:
  - it: should not inject env var by default
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY
          any: true

  - it: should inject WS_SECRETS_MASTER_KEY via secretKeyRef when autoGenerateMasterKey is true
    set:
      workspace:
        secrets:
          autoGenerateMasterKey: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-master-key
                key: master-key
