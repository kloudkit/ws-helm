---
suite: Value overrides
templates:
  - templates/workspace.yaml
tests:
  - it: should use alternate server port on Service
    set:
      workspace:
        port: 3000
    documentSelector:
      path: kind
      value: Service
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 3000

  - it: should set WS_SERVER_PORT env and update probes for alternate port
    set:
      workspace:
        port: 3000
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SERVER_PORT
            value: "3000"
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 3000
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 3000

  - it: should use alternate root for PVC mount and env
    set:
      workspace:
        root: /home/kloud
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: /home/kloud
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].subPath
          value: workspace
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SERVER_ROOT_DIR
            value: /home/kloud

  - it: should not mount volumes when persistence is disabled
    set:
      workspace:
        persistence:
          enabled: false
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].volumeMounts
      - isNull:
          path: spec.template.spec.volumes

  - it: should use custom image repository
    set:
      workspace:
        image:
          repository: custom/image
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom/image:v0.1.2

  - it: should use custom image tag
    set:
      workspace:
        image:
          tag: latest
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/kloudkit/workspace:latest

  - it: should set TZ env when timezone is configured
    set:
      workspace:
        timezone: America/New_York
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TZ
            value: America/New_York

  - it: should set WS_SERVER_PROXY_DOMAIN env from domains config
    set:
      workspace:
        domains:
          primary: primary.example.com
          proxies:
            - secondary.example.com
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SERVER_PROXY_DOMAIN
            value: "primary.example.com secondary.example.com"

  - it: should set container securityContext
    set:
      workspace:
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - matchSnapshot:
          path: spec.template.spec.containers[0].securityContext

  - it: should support templated hostname
    set:
      workspace:
        hostname: "{{ .Release.Name }}-ws"
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.hostname
          value: RELEASE-NAME-ws

  - it: should set custom storageClass on PVC
    set:
      workspace:
        persistence:
          storageClass: fast-ssd
    documentSelector:
      path: kind
      value: PersistentVolumeClaim
    asserts:
      - equal:
          path: spec.storageClassName
          value: fast-ssd

  - it: should set custom size on PVC
    set:
      workspace:
        persistence:
          size: 100Gi
    documentSelector:
      path: kind
      value: PersistentVolumeClaim
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: 100Gi

  - it: should set custom accessMode on PVC
    set:
      workspace:
        persistence:
          accessMode: ReadWriteMany
    documentSelector:
      path: kind
      value: PersistentVolumeClaim
    asserts:
      - equal:
          path: spec.accessModes
          value:
            - ReadWriteMany

  - it: should mount additional paths from the same PVC
    set:
      workspace:
        persistence:
          additionalPaths:
            - name: ssh
              path: /home/kloud/.ssh
            - name: config
              path: /home/kloud/.config
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            mountPath: /home/kloud/.ssh
            name: workspace
            subPath: ssh
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            mountPath: /home/kloud/.config
            name: workspace
            subPath: config

  - it: should only have default volumeMounts when no additionalMounts
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers[0].volumeMounts
          count: 1
