---
suite: Master key secret
templates:
  - templates/master-key.yaml
tests:
  - it: should not render Secret by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should auto-generate a Secret when autoGenerateMasterKey is true
    set:
      workspace:
        secrets:
          autoGenerateMasterKey: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-master-key
      - isNotNull:
          path: data.master-key
      - equal:
          path: metadata.labels["ws.kloudkit.com/auto-generated"]
          value: "true"

  - it: should use user-provided masterKey in Secret
    set:
      workspace:
        secrets:
          masterKey: my-custom-key
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-master-key
      - equal:
          path: data.master-key
          value: bXktY3VzdG9tLWtleQ==
      - notExists:
          path: metadata.labels["ws.kloudkit.com/auto-generated"]

  - it: should still render Secret when masterKey is set even if autoGenerate is false
    set:
      workspace:
        secrets:
          masterKey: explicit-key
          autoGenerateMasterKey: false
    asserts:
      - equal:
          path: data.master-key
          value: ZXhwbGljaXQta2V5

  - it: should preserve existing master-key on upgrade (auto-generate)
    set:
      workspace:
        secrets:
          autoGenerateMasterKey: true
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - kind: Secret
          apiVersion: v1
          metadata:
            name: RELEASE-NAME-master-key
            namespace: NAMESPACE
          data:
            master-key: cHJldmlvdXMta2V5LXZhbHVl
    asserts:
      - equal:
          path: data.master-key
          value: cHJldmlvdXMta2V5LXZhbHVl

  - it: should override existing secret when masterKey is explicitly set
    set:
      workspace:
        secrets:
          masterKey: new-explicit-key
    kubernetesProvider:
      scheme:
        v1/Secret:
          gvr:
            version: v1
            resource: secrets
          namespaced: true
      objects:
        - kind: Secret
          apiVersion: v1
          metadata:
            name: RELEASE-NAME-master-key
            namespace: NAMESPACE
          data:
            master-key: cHJldmlvdXMta2V5LXZhbHVl
    asserts:
      - equal:
          path: data.master-key
          value: bmV3LWV4cGxpY2l0LWtleQ==
