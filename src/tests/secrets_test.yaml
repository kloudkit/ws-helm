---
suite: Master key secret
release:
  name: my-release
  namespace: my-namespace
tests:
  - it: should not render Secret by default
    templates:
      - templates/master-key.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should auto-generate a Secret when autoGenerateMasterKey is true
    templates:
      - templates/master-key.yaml
    set:
      workspace:
        secrets:
          autoGenerateMasterKey: true
    asserts:
      - equal:
          path: metadata.name
          value: my-release-master-key
      - isNotNull:
          path: data.master-key
      - equal:
          path: metadata.labels["ws.kloudkit.com/auto-generated"]
          value: "true"

  - it: should use user-provided masterKey in Secret
    templates:
      - templates/master-key.yaml
    set:
      workspace:
        secrets:
          masterKey: my-custom-key
    asserts:
      - equal:
          path: metadata.name
          value: my-release-master-key
      - equal:
          path: data.master-key
          value: bXktY3VzdG9tLWtleQ==
      - notExists:
          path: metadata.labels["ws.kloudkit.com/auto-generated"]

  - it: should still render Secret when masterKey is set even if autoGenerate is false
    templates:
      - templates/master-key.yaml
    set:
      workspace:
        secrets:
          masterKey: explicit-key
          autoGenerateMasterKey: false
    asserts:
      - equal:
          path: data.master-key
          value: ZXhwbGljaXQta2V5

  - it: should not inject env var by default
    templates:
      - templates/workspace.yaml
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY
          any: true

  - it: should inject WS_SECRETS_MASTER_KEY via secretKeyRef when autoGenerateMasterKey is true
    templates:
      - templates/workspace.yaml
    set:
      workspace:
        secrets:
          autoGenerateMasterKey: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY
            valueFrom:
              secretKeyRef:
                name: my-release-master-key
                key: master-key
