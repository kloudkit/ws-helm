---
suite: Metrics configuration
set:
  workspace:
    config:
      metrics:
        enable: true
tests:
  - it: should add metrics port and env when enabled
    documentSelector:
      path: kind
      value: Service
    asserts:
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[1].name
          value: metrics
      - equal:
          path: spec.ports[1].port
          value: 9100

  - it: should set WS_METRICS_ENABLE env when enabled
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_METRICS_ENABLE
            value: "true"

  - it: should use custom metrics port
    set:
      workspace:
        config:
          metrics:
            enable: true
            port: 9200
    documentSelector:
      path: kind
      value: Service
    asserts:
      - equal:
          path: spec.ports[1].port
          value: 9200

  - it: should set WS_METRICS_PORT env for custom port
    set:
      workspace:
        config:
          metrics:
            enable: true
            port: 9200
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_METRICS_PORT
            value: "9200"

  - it: should set WS_METRICS_COLLECTORS env
    set:
      workspace:
        config:
          metrics:
            enable: true
            collectors:
              - cpu
              - memory
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_METRICS_COLLECTORS
            value: cpu,memory
