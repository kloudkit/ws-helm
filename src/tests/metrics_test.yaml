---
suite: Metrics configuration
templates:
  - templates/workspace.yaml
set:
  workspace:
    metrics:
      enabled: true
tests:
  - it: should add metrics port and env when enabled
    documentSelector:
      path: kind
      value: Service
    asserts:
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[1].name
          value: metrics
      - equal:
          path: spec.ports[1].port
          value: 9100

  - it: should set WS_METRICS_ENABLE env when enabled
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_METRICS_ENABLE
            value: "true"

  - it: should use custom metrics port
    set:
      workspace:
        metrics:
          enabled: true
          port: 9200
    documentSelector:
      path: kind
      value: Service
    asserts:
      - equal:
          path: spec.ports[1].port
          value: 9200

  - it: should set WS_METRICS_PORT env for custom port
    set:
      workspace:
        metrics:
          enabled: true
          port: 9200
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_METRICS_PORT
            value: "9200"

  - it: should set WS_METRICS_COLLECTORS env
    set:
      workspace:
        metrics:
          enabled: true
          collectors:
            - cpu
            - memory
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_METRICS_COLLECTORS
            value: cpu,memory

  - it: should create ServiceMonitor when metrics enabled
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    documentSelector:
      path: kind
      value: ServiceMonitor
    asserts:
      - isNotNull:
          path: spec.selector.matchLabels
      - matchSnapshot:
          path: spec.endpoints

  - it: should not create ServiceMonitor when CRD not available
    asserts:
      - not: true
        containsDocument:
          kind: ServiceMonitor
          apiVersion: monitoring.coreos.com/v1

  - it: should use custom ServiceMonitor interval and scrapeTimeout
    set:
      workspace:
        metrics:
          enabled: true
          interval: 30s
          scrapeTimeout: 5s
    capabilities:
      apiVersions:
        - monitoring.coreos.com/v1
    documentSelector:
      path: kind
      value: ServiceMonitor
    asserts:
      - equal:
          path: spec.endpoints[0].interval
          value: 30s
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 5s
