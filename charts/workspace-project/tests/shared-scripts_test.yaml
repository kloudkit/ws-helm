---
suite: Shared scripts ConfigMap
templates:
  - templates/scripts.configmap.yaml
release:
  name: my-release
tests:
  - it: should not render when scripts is not set
    set:
      project.name: myproject
    asserts:
      - hasDocuments:
          count: 0

  - it: should render when scripts is enabled
    set:
      project.name: myproject
      project.scripts.enabled: true
      project.scripts.scripts:
        setup.sh: |
          #!/bin/bash
          echo "hello"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: kind
          value: ConfigMap

  - it: should use correct name
    set:
      project.name: myproject
      project.scripts.enabled: true
      project.scripts.scripts:
        setup.sh: "echo hi"
    asserts:
      - equal:
          path: metadata.name
          value: myproject-scripts

  - it: should be in the project namespace
    set:
      project.name: myproject
      project.scripts.enabled: true
      project.scripts.scripts:
        setup.sh: "echo hi"
    asserts:
      - equal:
          path: metadata.namespace
          value: ws-myproject

  - it: should populate data from scripts map
    set:
      project.name: myproject
      project.scripts.enabled: true
      project.scripts.scripts:
        setup.sh: |
          #!/bin/bash
          echo "bootstrap"
        install.sh: |
          #!/bin/bash
          apt-get install -y curl
    asserts:
      - matchRegex:
          path: data["setup.sh"]
          pattern: "bootstrap"
      - matchRegex:
          path: data["install.sh"]
          pattern: "curl"
