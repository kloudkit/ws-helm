---
suite: Optional namespace resources
release:
  name: my-release

tests:
  # --- env ConfigMap ---

  - it: should not render ConfigMap when env is disabled
    templates:
      - templates/env.configmap.yaml
    set:
      project.name: myproject
    asserts:
      - hasDocuments:
          count: 0

  - it: should render ConfigMap when env is enabled
    templates:
      - templates/env.configmap.yaml
    set:
      project.name: myproject
      project.env.enabled: true
      project.env.data:
        TZ: UTC
        LANG: en_US.UTF-8
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: kind
          value: ConfigMap
      - equal:
          path: metadata.name
          value: myproject-env
      - equal:
          path: metadata.namespace
          value: ws-myproject
      - equal:
          path: data.TZ
          value: UTC

  # --- secret Secret ---

  - it: should not render Secret when secret is disabled
    templates:
      - templates/secret.yaml
    set:
      project.name: myproject
    asserts:
      - hasDocuments:
          count: 0

  - it: should render Secret when secret is enabled
    templates:
      - templates/secret.yaml
    set:
      project.name: myproject
      project.secret.enabled: true
      project.secret.data:
        DB_PASSWORD: s3cr3t
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: kind
          value: Secret
      - equal:
          path: metadata.name
          value: myproject
      - equal:
          path: metadata.namespace
          value: ws-myproject
      - equal:
          path: stringData.DB_PASSWORD
          value: s3cr3t

  # --- PersistentVolumeClaim ---

  - it: should not render PVC when persistence is disabled (default)
    templates:
      - templates/pvc.yaml
    set:
      project.name: myproject
    asserts:
      - hasDocuments:
          count: 0

  - it: should render PVC when persistence is enabled
    templates:
      - templates/pvc.yaml
    set:
      project.name: myproject
      project.persistence.enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: kind
          value: PersistentVolumeClaim

  - it: should name PVC <project.name>-shared
    templates:
      - templates/pvc.yaml
    set:
      project.name: myproject
      project.persistence.enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: myproject-shared
      - equal:
          path: metadata.namespace
          value: ws-myproject

  - it: should set ReadWriteMany access mode by default
    templates:
      - templates/pvc.yaml
    set:
      project.name: myproject
      project.persistence.enabled: true
    asserts:
      - contains:
          path: spec.accessModes
          content: ReadWriteMany

  - it: should use custom storageClass when set
    templates:
      - templates/pvc.yaml
    set:
      project.name: myproject
      project.persistence.enabled: true
      project.persistence.storageClass: fast-ssd
    asserts:
      - equal:
          path: spec.storageClassName
          value: fast-ssd

  - it: should use custom size when set
    templates:
      - templates/pvc.yaml
    set:
      project.name: myproject
      project.persistence.enabled: true
      project.persistence.size: 50Gi
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: 50Gi

  # --- ResourceQuota ---

  - it: should not render ResourceQuota when quota is disabled
    templates:
      - templates/resourcequota.yaml
    set:
      project.name: myproject
    asserts:
      - hasDocuments:
          count: 0

  - it: should render ResourceQuota when quota is enabled
    templates:
      - templates/resourcequota.yaml
    set:
      project.name: myproject
      project.quota.enabled: true
      project.quota.hard:
        requests.cpu: "4"
        requests.memory: 8Gi
        pods: "10"
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: kind
          value: ResourceQuota
      - equal:
          path: metadata.name
          value: myproject
      - equal:
          path: metadata.namespace
          value: ws-myproject
      - equal:
          path: spec.hard["requests.cpu"]
          value: "4"
      - equal:
          path: spec.hard["pods"]
          value: "10"
