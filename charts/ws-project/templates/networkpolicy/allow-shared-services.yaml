{{- $p := .Values.project | default dict -}}
{{- if (dig "network" "intraNamespace" true $p) }}
---
# Allow shared services (pods without ws.kloudkit.com/owner label) to
# communicate with any pod in the namespace. This ensures databases,
# microservices, and other non-workspace pods remain reachable.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-shared-services
  namespace: {{ include "ws-project.namespace" . }}
spec:
  podSelector:
    matchExpressions:
      - key: ws.kloudkit.com/owner
        operator: DoesNotExist
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector: {}
  egress:
    - to:
        - podSelector: {}
{{- end }}
