---
suite: Labels and annotations
templates:
  - templates/workspace.yaml
tests:
  - it: should apply global labels to all resources
    set:
      workspace:
        labels:
          team: platform
    documentSelector:
      path: metadata.labels["team"]
      value: platform
      matchMany: true
    asserts:
      - isNotNullOrEmpty:
          path: metadata.labels["team"]

  - it: should set owner label on all resources
    set:
      workspace:
        owner: alice
        ingress:
          enabled: true
    documentSelector:
      path: metadata.labels["ws.kloudkit.com/owner"]
      value: alice
      matchMany: true
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            ws.kloudkit.com/owner: alice

  - it: should merge owner and custom labels
    set:
      workspace:
        owner: alice
        labels:
          team: platform
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            ws.kloudkit.com/owner: alice
            team: platform

  - it: should set firewall label when isolated
    set:
      workspace:
        firewall: isolated
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            ws.kloudkit.com/firewall: isolated

  - it: should set project label when workspace.project is a string
    set:
      workspace:
        project: myproject
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            ws.kloudkit.com/project: myproject

  - it: should set project label when workspace.project.name is set (object form)
    set:
      workspace:
        project:
          name: myproject
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - isSubset:
          path: metadata.labels
          content:
            ws.kloudkit.com/project: myproject

  - it: should apply global annotations
    set:
      workspace:
        annotations:
          example.com/note: hello
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: metadata.annotations["example.com/note"]
          value: hello
