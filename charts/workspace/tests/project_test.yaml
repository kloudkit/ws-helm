---
suite: Project shared resource mounting
templates:
  - templates/workspace.yaml
tests:
  - it: should mount shared env ConfigMap when sharedEnvs is true
    set:
      workspace:
        project:
          name: myproject
          sharedEnvs: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: myproject-env

  - it: should mount shared Secret when sharedSecrets is true
    set:
      workspace:
        project:
          name: myproject
          sharedSecrets: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: myproject

  - it: should use custom ConfigMap name when sharedEnvs is a string
    set:
      workspace:
        project:
          name: myproject
          sharedEnvs: custom-cm
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: custom-cm

  - it: should use custom Secret name when sharedSecrets is a string
    set:
      workspace:
        project:
          name: myproject
          sharedSecrets: custom-secret
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: custom-secret

  - it: should include both project entries and user envFrom entries
    set:
      workspace:
        project:
          name: myproject
          sharedEnvs: true
        envFrom:
          - configMapRef:
              name: extra-cm
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: myproject-env
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: extra-cm

  - it: should mount shared PVC at /shared when sharedPVC is true
    set:
      workspace:
        project:
          name: myproject
          sharedPVC: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.volumes[?(@.name == "shared")].persistentVolumeClaim.claimName
          value: myproject-shared

  - it: should use custom PVC name when sharedPVC is a string
    set:
      workspace:
        project:
          name: myproject
          sharedPVC: custom-pvc
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - equal:
          path: spec.template.spec.volumes[?(@.name == "shared")].persistentVolumeClaim.claimName
          value: custom-pvc

  - it: should not mount shared PVC when project is string only
    set:
      workspace:
        project: myproject
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - notExists:
          path: spec.template.spec.volumes[?(@.name == "shared")]

  - it: should not add envFrom when project is string only
    set:
      workspace:
        project: myproject
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].envFrom
