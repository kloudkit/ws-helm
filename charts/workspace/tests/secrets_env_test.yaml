---
suite: Master key env injection
templates:
  - templates/workspace.yaml
tests:
  - it: should not inject env var by default
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY
          any: true
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY_FILE
          any: true

  - it: should inject WS_SECRETS_MASTER_KEY_FILE when autoGenerateMasterKey is true
    set:
      workspace:
        secrets:
          autoGenerateMasterKey: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY_FILE
            value: /run/secrets/workspace/master-key
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: WS_SECRETS_MASTER_KEY
          any: true

  - it: should mount master-key secret volume when autoGenerateMasterKey is true
    set:
      workspace:
        secrets:
          autoGenerateMasterKey: true
    documentSelector:
      path: kind
      value: Deployment
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: master-key
            secret:
              secretName: RELEASE-NAME-master-key
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: master-key
            mountPath: /run/secrets/workspace
            readOnly: true
