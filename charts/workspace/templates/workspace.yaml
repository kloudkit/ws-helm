{{- define "workspace.hardcodedValues" -}}
  {{- $ws := .Values.workspace | default dict -}}
  {{- $port := dig "port" 8080 $ws -}}
  {{- $metricsEnabled := dig "metrics" "enabled" false $ws -}}
  {{- $metricsPort := dig "metrics" "port" 9100 $ws -}}
  {{- $allDomains := include "workspace.proxyDomains" . | fromJsonArray -}}
global:
  {{- $labels := dict }}
  {{- with (dig "owner" nil $ws) }}
    {{- $_ := set $labels "ws.kloudkit.com/owner" (toString .) }}
  {{- end }}
  {{- with (dig "firewall" nil $ws) }}
    {{- $_ := set $labels "ws.kloudkit.com/firewall" (toString .) }}
  {{- end }}
  {{- with (include "workspace.projectName" . | trim) }}
    {{- $_ := set $labels "ws.kloudkit.com/project" . }}
  {{- end }}
  {{- with (dig "labels" nil $ws) }}
    {{- $_ := mergeOverwrite $labels . }}
  {{- end }}
  labels: {{ toYaml $labels | nindent 4 }}
  annotations: {{ toYaml (dig "annotations" (dict) $ws) | nindent 4 }}

controllers:
  main:
    revisionHistoryLimit: 3

    pod:
  {{- with (dig "hostname" nil $ws) }}
      hostname: {{ tpl (toString .) $ | quote }}
  {{- end }}

  {{- with (dig "nodeSelector" nil $ws) }}
      nodeSelector: {{ toYaml . | nindent 8 }}
  {{- end }}

  {{- with (dig "tolerations" nil $ws) }}
      tolerations: {{ toYaml . | nindent 8 }}
  {{- end }}

  {{- with (dig "affinity" nil $ws) }}
      affinity: {{ toYaml . | nindent 8 }}
  {{- end }}

    containers:
      main:
        image:
          repository: {{ dig "image" "repository" "ghcr.io/kloudkit/workspace" $ws }}
          tag: {{ dig "image" "tag" .Chart.AppVersion $ws | quote }}
          pullPolicy: {{ dig "image" "pullPolicy" "IfNotPresent" $ws }}

        env:
  {{- with (dig "timezone" nil $ws) }}
          TZ: {{ . | quote }}
  {{- end }}

  {{- with (dig "port" nil $ws) }}
          WS_SERVER_PORT: {{ . | quote }}
  {{- end }}

  {{- with (dig "root" nil $ws) }}
          WS_SERVER_ROOT_DIR: {{ . | quote }}
  {{- end }}

  {{- if $metricsEnabled }}
          WS_METRICS_ENABLE: "true"
          WS_METRICS_PORT: {{ $metricsPort | quote }}
    {{- with (dig "metrics" "collectors" nil $ws) }}
          WS_METRICS_COLLECTORS: {{ . | join "," | quote }}
    {{- end }}
  {{- end }}

  {{- if $allDomains }}
          WS_SERVER_PROXY_DOMAIN: {{ $allDomains | join " " | quote }}
  {{- end }}

  {{- $secrets := dig "secrets" dict $ws }}
  {{- $hasMasterKey := or (dig "masterKey" "" $secrets) (dig "autoGenerateMasterKey" false $secrets) }}
  {{- if $hasMasterKey }}
          WS_SECRETS_MASTER_KEY_FILE: "/run/secrets/workspace/master-key"
  {{- end }}

  {{- with (dig "featureStore" nil $ws) }}
    {{- if kindIs "bool" . }}
      {{- if . }}
          WS_FEATURES_STORE_URL: "http://workspace-system-store.workspace-system.svc"
      {{- end }}
    {{- else }}
          WS_FEATURES_STORE_URL: {{ . | quote }}
    {{- end }}
  {{- end }}

          {{- include "workspace.wsEnv" . | nindent 10 }}

  {{- with (dig "env" nil $ws) }}
          {{- toYaml . | nindent 10 }}
  {{- end }}

  {{- with include "workspace.envFrom" . }}
        envFrom:
          {{- . | nindent 10 }}
  {{- end }}

  {{- with (dig "securityContext" nil $ws) }}
        securityContext: {{ toYaml . | nindent 10 }}
  {{- end }}

  {{- with (dig "resources" nil $ws) }}
        resources: {{ toYaml . | nindent 10 }}
  {{- end }}

        probes:
          liveness:
            enabled: true
            type: HTTP
            path: /healthz
            port: {{ $port }}

          readiness:
            enabled: true
            type: HTTP
            path: /healthz
            port: {{ $port }}

service:
  main:
    controller: main
    ports:
      http:
        port: {{ $port }}
  {{- if $metricsEnabled }}
      metrics:
        port: {{ $metricsPort }}
  {{- end }}

  {{- if $metricsEnabled }}
serviceMonitor:
  main:
    enabled: true
    endpoints:
      - port: metrics
        scheme: http
        path: /
        interval: {{ dig "metrics" "interval" "1m" $ws }}
        scrapeTimeout: {{ dig "metrics" "scrapeTimeout" "10s" $ws }}
  {{- end }}

  {{- if (dig "ingress" "enabled" false $ws) }}
ingress:
  main:
    {{- with (dig "ingress" "className" nil $ws) }}
    className: {{ . }}
    {{- end }}
    hosts:
    {{- if $allDomains }}
      {{- range $allDomains }}
        {{- $host := include "workspace.stripPort" (dict "raw" (toString .) "ctx" $) }}
      - host: {{ $host | quote }}
        paths: &defaultPaths
          - path: /
            service:
              identifier: main
              port: http
      - host: {{ printf "*.%s" $host | quote }}
        paths: *defaultPaths
      {{- end }}
    {{- end }}
    {{- with (dig "ingress" "tls" nil $ws) }}
    tls: {{ toYaml . | nindent 6 }}
    {{- end }}
    {{- with (dig "ingress" "annotations" nil $ws) }}
    annotations: {{ toYaml . | nindent 6 }}
    {{- end }}
  {{- end }}

  {{- $persEnabled := dig "persistence" "enabled" true $ws -}}
  {{- $extraPers := dig "persistence" "extra" dict $ws -}}
  {{- if or $persEnabled $extraPers $hasMasterKey }}
persistence:
  {{- if $persEnabled }}
  workspace:
    type: {{ dig "persistence" "type" "persistentVolumeClaim" $ws }}
    accessMode: {{ dig "persistence" "accessMode" "ReadWriteOnce" $ws }}
    size: {{ dig "persistence" "size" "25Gi" $ws }}
    {{- with (dig "persistence" "existingClaim" nil $ws) }}
    existingClaim: {{ . }}
    {{- end }}
    {{- with (dig "persistence" "storageClass" nil $ws) }}
    storageClass: {{ . }}
    {{- end }}
    globalMounts:
      - path: {{ dig "root" "/workspace" $ws }}
        subPath: workspace
      - path: /home/kloud/.ws
        subPath: ws
    {{- range (dig "persistence" "additionalPaths" list $ws) }}
      - path: {{ .path }}
        subPath: {{ .name }}
    {{- end }}
  {{- end }}
  {{- if $hasMasterKey }}
  master-key:
    type: secret
    name: {{ printf "%s-master-key" $.Release.Name }}
    globalMounts:
      - path: /run/secrets/workspace
        readOnly: true
  {{- end }}
  {{- $projectName := include "workspace.projectName" . | trim }}
  {{- $project := dig "project" nil $ws }}
  {{- if kindIs "map" $project }}
    {{- $pvcName := include "workspace.projectRef" (dict "val" (dig "sharedPVC" false $project) "default" (printf "%s-shared" $projectName)) | trim }}
    {{- if $pvcName }}
  shared:
    type: persistentVolumeClaim
    existingClaim: {{ $pvcName }}
    globalMounts:
      - path: /shared
    {{- end }}
  {{- end }}
  {{- range $name, $entry := $extraPers }}
  {{ $name }}: {{ toYaml $entry | nindent 4 }}
  {{- end }}
  {{- end }}
{{- end }}

{{- $ctx := deepCopy . -}}
{{- $_ := include "workspace.hardcodedValues" . | fromYaml | mergeOverwrite $ctx.Values -}}
{{- include "bjw-s.common.loader.all" $ctx }}
