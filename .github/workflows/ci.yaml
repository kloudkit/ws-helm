---
name: â˜¸ CI

on:
  push:
  workflow_dispatch:

jobs:
  lint:
    name: ğŸ§¹ Lint
    runs-on: ubuntu-latest
    if: github.actor != 'renovate[bot]'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ§¹ Lint
        uses: pre-commit/action@v3.0.1

  test:
    name: ğŸ§ª Test (${{ matrix.chart }})
    runs-on: ubuntu-latest
    needs:
      - lint

    strategy:
      matrix:
        include:
          - chart: workspace
            has_deps: true
            has_generate: true
            has_tests: true

          - chart: workspace-project
            has_deps: false
            has_generate: false
            has_tests: true

          - chart: workspace-system
            has_deps: true
            has_generate: false
            has_tests: true

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: â˜¸ Setup Helm
        uses: azure/setup-helm@v3

      - name: ğŸ”Œ Install helm-unittest plugin
        if: matrix.has_tests
        run: helm plugin install https://github.com/helm-unittest/helm-unittest --version v1.0.2

      - name: ğŸ”Œ Add repo and build dependencies
        if: matrix.has_deps
        run: |
          helm repo add bjw-s https://bjw-s-labs.github.io/helm-charts --force-update
          helm dependency build charts/${{ matrix.chart }}/

      - name: ğŸ“¦ Install yq
        if: matrix.has_generate
        uses: mikefarah/yq@master

      - name: ğŸ”„ Generate files
        if: matrix.has_generate
        run: charts/${{ matrix.chart }}/scripts/generate.sh

      - name: ğŸ§ª Run tests
        if: matrix.has_tests
        run: helm unittest -f "tests/**/*.yaml" ./charts/${{ matrix.chart }}
